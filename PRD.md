# 产品需求说明（PRD）

## 项目名称
### Idea Execution Loop（想法执行闭环系统）

## 目录名称
`ideas`

## 产品技术栈和表现形式
本产品为纯 API 产品，不涉及前端界面设计，主要面向 AI Agent 调用和用户通过 API 交互。
- 框架：**FastAPI**
- 数据存储：**SQLite**

---

## 1. 背景与目标

在日常工作和思考过程中，用户会产生大量“想法”。其中一部分想法不仅需要被记录，还希望能够被立刻执行、被持续推进，并在执行过程中与 AI Agent 进行多轮协作。

现有的笔记工具只解决“记录”，任务工具只解决“单次执行”，而 AI 工具通常缺乏长期上下文、可回溯的执行协作机制。

**项目目标：** 构建一个以“想法”为中心，支持立刻执行、Agent 轮询处理、人机多轮反馈、全过程可追溯的执行闭环系统。

---

## 2. 用户与使用场景

### 2.1 目标用户
- 单一用户（本人）
- 高度依赖 AI Agent 辅助思考、执行、拆解任务
- 需要反复介入、指示、调整方向，而不是一次性下指令

### 2.2 核心使用场景
1. 记录一个尚未完全想清楚的想法
2. 决定让 AI Agent 立刻开始执行
3. 执行过程中：
   - Agent 会反馈进度
   - Agent 可能卡住并向用户提问
4. 用户看到反馈后：
   - 在同一条想法下追加说明/指示（类似评论）
5. Agent 继续执行
6. 重复以上过程，直到想法被完成、放弃或终止

---

## 3. 核心概念定义（业务层）

### 3.1 想法（Idea）
- 想法是系统中的核心业务对象
- 既可以只是一个记录，也可以演变成一个正在执行的任务
- 一个想法只对应一个执行主线

### 3.2 执行线程（Thread）
- 每个想法都有一条时间线
- 线程中按顺序记录：用户输入、Agent 反馈、系统状态变化
- 所有历史不可删除，用于回溯与上下文理解

### 3.3 消息 / 事件（Message / Event）
线程中的每一条记录都是一个事件，包括但不限于：
- 用户追加的说明、评论、指示
- Agent 的执行进度、结果、问题
- 系统自动记录的状态变化

---

## 4. 功能需求

### 4.1 想法管理
#### 4.1.1 创建想法
用户可以：
- 输入一段自由文本作为想法内容
- 保存为“仅记录”的状态

#### 4.1.2 编辑想法
在未执行或执行过程中：
- 用户可以补充、修正想法内容
- 不影响历史线程内容（历史不可被修改）

---

### 4.2 立刻执行机制
#### 4.2.1 立刻执行开关
- 用户可以在想法上选择 **【立刻执行】**
- 一旦触发：
  - 系统将该想法标记为“可被 Agent 处理”
  - 记录一条系统事件：执行请求已发出

#### 4.2.2 可执行状态
- 只有处于“可执行状态”的想法，Agent 才能获取
- 未勾选立刻执行的想法，Agent 永远不可见

---

### 4.3 Agent 处理机制（业务视角）
> 注：本 PRD 不关心 Agent 如何执行任务，只关心协作规则。

#### 4.3.1 任务领取
- Agent 以轮询方式查询系统
- 系统只允许一个 Agent 成功领取某个想法
- 一旦领取成功：该想法进入“执行中”状态，其他 Agent 不可再处理该想法

#### 4.3.2 执行反馈
- Agent 在执行过程中可以多次反馈：当前进展、中间结果、执行日志摘要
- 每次反馈都会作为一条消息追加到该想法的线程中

---

### 4.4 等待用户指示机制（关键功能）
#### 4.4.1 Agent 主动暂停
当 Agent 遇到以下情况之一时：信息不足、需要决策（A/B/C）、发现多种执行路径、无法继续推进。

Agent 可以：
- 向线程中追加一条“问题/请求指示”的消息
- 将该想法标记为“等待用户指示”

#### 4.4.2 用户追加指示
- 用户在该想法下追加新的内容
- 在“等待用户指示”状态下，用户的追加内容被视为“继续执行的指令”，系统自动将想法标记为“等待 Agent 继续执行”

---

### 4.5 多轮协作执行
- 同一个想法允许经历多次：执行 → 暂停 → 用户指示 → 继续执行
- 所有轮次都记录在同一条线程中
- Agent 每次继续执行时，都可以看到完整历史上下文

---

### 4.6 执行结束
#### 4.6.1 完成
- Agent 可以声明任务已完成，系统记录完成事件，想法进入“已完成”状态

#### 4.6.2 失败
- 当任务不可继续时，Agent 可声明失败，必须附带失败原因说明

#### 4.6.3 用户取消
- 用户可随时手动取消执行，被取消的想法不会再被 Agent 处理

---

## 5. 状态管理（业务规则）

### 5.1 想法状态集合
- 草稿（仅记录）
- 待执行
- 已被 Agent 领取
- 执行中
- 等待用户指示
- 等待 Agent 继续
- 已完成
- 已失败
- 已取消

### 5.2 状态流转原则
- 状态变化必须可解释、可追溯
- 每一次状态变化都记录为系统事件
- 不允许跳跃式、不透明的状态变化

---

## 6. 线程与历史要求
- 每个想法拥有一条完整的历史线程
- 线程必须满足：按时间顺序排列、不可删除、不可篡改、可完整回放执行过程
- 线程用于：Agent 理解上下文、用户复盘决策过程、排查执行中断原因

---

## 7. 非目标（明确不做什么）
- 不设计 Agent 的内部执行逻辑
- 不做自动化工作流编排
- 不做复杂权限体系（默认单用户）
- 不追求实时推送（允许轮询）
- 不作为通用项目管理工具

---

## 8. 成功标准（验收标准） ✅
当系统满足以下条件，即视为符合本 PRD：
1. 用户可以把一个想法从“记录”推进到“完成”
2. Agent 可以安全、唯一地领取想法并执行
3. 用户与 Agent 可以围绕同一想法进行多轮交互
4. 执行过程与状态变化全部可追溯
5. 用户始终对执行节奏拥有最终控制权

---

## 9. 产品一句话总结
> 这是一个让“想法”可以被立刻执行，并在执行过程中持续与 AI Agent 对话、修正和推进的闭环系统。
